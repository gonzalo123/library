/*
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./SelectionPlugin","./PluginBase","../library","../utils/TableUtils","sap/ui/core/Icon","sap/ui/core/IconPool","sap/base/Log"],function(e,t,i,n,o,s,l){"use strict";const r=i.plugins.SelectionMode;const c=i.SelectionMode;const a=n.createWeakMapFacade();const g=e.extend("sap.ui.table.plugins.ODataV4Selection",{metadata:{library:"sap.ui.table",properties:{selectionMode:{type:"sap.ui.table.plugins.SelectionMode",group:"Behavior",defaultValue:r.MultiToggle},limit:{type:"int",group:"Behavior",defaultValue:200},enableNotification:{type:"boolean",group:"Behavior",defaultValue:false},hideHeaderSelector:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{icon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}},events:{selectionChange:{}}}});g.findOn=t.findOn;g.prototype.init=function(){e.prototype.init.apply(this,arguments);const t=new o({src:s.getIconURI(n.ThemeParameters.checkboxIcon),useIconTooltip:false});t.addStyleClass("sapUiTableSelectClear");this.setAggregation("icon",t,true);a(this).bLimitReached=false;a(this).oRangeSelectionStartContext=null};g.prototype.onActivate=function(t){e.prototype.onActivate.apply(this,arguments);t.setProperty("selectionMode",this.getSelectionMode())};g.prototype.onDeactivate=function(t){e.prototype.onDeactivate.apply(this,arguments);t.setProperty("selectionMode",c.None);y(this,this.getTableBinding());clearTimeout(this.iSelectionChangeTimeout)};g.prototype.setSelected=function(e,t,i){const n=e.getRowBindingContext();if(!this.isActive()||!n||!C(n)){return}if(i?.range){u(this,e);return}if(this.isSelected(e)===t){return}n.setSelected(t);a(this).oRangeSelectionStartContext=t&&this.getSelectionMode()===r.MultiToggle?n:null};function u(e,t){if(!a(e).oRangeSelectionStartContext){return}let i=a(e).oRangeSelectionStartContext.getIndex();const n=t.getRowBindingContext();const o=n?n.getIndex():-1;if(i!==o){i+=o>i?1:-1}m(e,i,o)}g.prototype.isSelected=function(e){const t=e.getRowBindingContext();return t?this.isActive()&&t.isSelected()&&C(t):false};g.prototype.getSelectedCount=function(){return this.getSelectedContexts().length};function d(e){const t=e.getTableBinding();if(!t){return 0}if(!t.isLengthFinal()){return-1}const i=t.getAggregation();const n="hierarchyQualifier"in(i||{});const o=!n&&!!i;let s=-1;if(o){const e=t.getAllCurrentContexts();if(t.getLength()===e.length){s=e.filter(function(e){return C(e)}).length}}else{s=t.getLength()}return s}function h(e){if(e._isLimitDisabled()){return}let t=s.getIconURI(n.ThemeParameters.checkboxIcon);if(e.getSelectedCount()>0){if(p(e)){t=s.getIconURI(n.ThemeParameters.allSelectedIcon)}else{t=s.getIconURI(n.ThemeParameters.clearSelectionIcon)}}e.getAggregation("icon").setSrc(t)}g.prototype.getRenderConfig=function(){if(!this.isActive()){return e.prototype.getRenderConfig.apply(this,arguments)}h(this);return{headerSelector:{type:this._isLimitDisabled()?"toggle":"custom",icon:this.getAggregation("icon"),visible:this.getSelectionMode()===r.MultiToggle&&!this.getHideHeaderSelector(),enabled:d(this)!==0,selected:p(this),tooltip:this.getSelectedCount()===0?n.getResourceText("TBL_SELECT_ALL"):n.getResourceText("TBL_DESELECT_ALL")}}};function f(e){if(p(e)){e.clearSelection();return false}else if(e._isLimitDisabled()){const t=e.getTableBinding();if(t&&t.getLength()){m(e,0,t.getLength()-1);return true}}return undefined}function p(e){const t=d(e);return t>0&&t===e.getSelectedCount()}g.prototype.onHeaderSelectorPress=function(){if(!this.isActive()){return}const e=this.getRenderConfig();if(!e.headerSelector.visible||!e.headerSelector.enabled){return}if(e.headerSelector.type==="toggle"){f(this)}else if(e.headerSelector.type==="custom"){if(this.getSelectedCount()>0){this.clearSelection()}else{const e=this.getTableBinding();if(e&&e.getLength()>0){m(this,0,e.getLength()-1)}}}};g.prototype.onKeyboardShortcut=function(e,t){if(!this.isActive()){return}if(e==="toggle"){if(this.getSelectionMode()!==r.MultiToggle){return}if(this._isLimitDisabled()){if(f(this)===false){t.setMarked("sapUiTableClearAll")}}else{const e=this.getTableBinding();if(e&&e.getLength()>0){m(this,0,e.getLength()-1)}}}else if(e==="clear"){this.clearSelection();t.setMarked("sapUiTableClearAll")}};g.prototype.setSelectionMode=function(e){const t=this.getTable();this.setProperty("selectionMode",e,true);a(this).oRangeSelectionStartContext=null;this.clearSelection();if(t){t.setProperty("selectionMode",this.getSelectionMode())}return this};g.prototype.setLimit=function(e){this.setProperty("limit",e);a(this).bLimitReached=false;return this};g.prototype.onTableRowsBound=function(t){if(!t.getModel().isA("sap.ui.model.odata.v4.ODataModel")){throw new Error("This plugin only works with a sap.ui.model.odata.v4.ODataModel.")}e.prototype.onTableRowsBound.apply(this,arguments);if(this.getSelectionMode()===r.Single){const e=t.getHeaderContext();if(e?.isSelected()){e.setSelected(false);l.error("The header context must not be selected in selection mode 'Single'.",this)}}S(this,t)};function S(e,t){if(t){t.attachEvent("selectionChanged",b,e)}}function y(e,t){if(t){t.detachEvent("selectionChanged",b,e)}}function b(e){const t=e.getParameter("context");const i=t===e.getSource().getHeaderContext();if(!i&&!C(t)){return}if(this.getSelectionMode()===r.Single&&t.isSelected()){if(i){t.setSelected(false);l.error("The header context must not be selected in selection mode 'Single'.",this)}else if(this.getSelectedCount()>1){this.clearSelection();t.setSelected(true)}}if(this.iSelectionChangeTimeout){return}this.iSelectionChangeTimeout=setTimeout(()=>{this.fireSelectionChange();delete this.iSelectionChangeTimeout},0)}g.prototype._isLimitDisabled=function(){return this.getLimit()===0};function m(e,t,i){const o=e.getTable();const s=e.getLimit();const l=i<t;let r=l?i:t;let c=Math.abs(i-t)+1;if(!e._isLimitDisabled()){a(e).bLimitReached=c>s;if(a(e).bLimitReached){if(l){i=t-s+1;r=i}else{i=t+s-1}c=s+1}}n.loadContexts(e.getTableBinding(),r,c).then(function(t){t.forEach(function(t){if(!C(t)||t.isSelected()){return}if(l&&t.getIndex()>=i||t.getIndex()<=i){t.setSelected(true)}if(t.getIndex()===i){a(e).oRangeSelectionStartContext=t}});if(a(e).bLimitReached){n.scrollTableToIndex(o,i,l).then(function(){if(e.getEnableNotification()){n.showNotificationPopoverAtIndex(o,i,e.getLimit())}})}})}function C(e){const t="hierarchyQualifier"in(e.getBinding().getAggregation()||{});return t||e.getProperty("@$ui5.node.isExpanded")===undefined&&!e.getProperty("@$ui5.node.isTotal")}g.prototype.clearSelection=function(){for(const e of this.getSelectedContexts()){e.setSelected(false)}};g.prototype.getSelectedContexts=function(){const e=this.getTableBinding();return this.isActive()&&e?e.getAllCurrentContexts().filter(function(e){return e.isSelected()&&C(e)}):[]};g.prototype.onThemeChanged=function(){h(this)};return g});
//# sourceMappingURL=ODataV4Selection.js.map